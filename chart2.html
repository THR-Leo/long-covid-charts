<!-- Chart 2 (stacked vertical column chart) -->
<div id="chart2-wrap" style="width:100%; max-width:740px; margin:0 auto;">
  <div id="chart2" style="width:100%;"></div>
</div>

<style>
  /* Prevent tooltip from capturing the mouse (common cause of flicker) */
  .google-visualization-tooltip{
    pointer-events: none !important;
  }
</style>

<script type="text/javascript">
  (function () {
    // Load Google Charts (only once per page)
    if (!window.__googleChartsLoaderAdded) {
      window.__googleChartsLoaderAdded = true;
      var s = document.createElement('script');
      s.src = 'https://www.gstatic.com/charts/loader.js';
      s.onload = initChart2;
      document.head.appendChild(s);
    } else {
      initChart2();
    }

    function initChart2() {
      if (!window.google || !google.charts) {
        // If loader hasn't finished yet, retry shortly.
        setTimeout(initChart2, 50);
        return;
      }
      google.charts.load('current', { packages: ['corechart'] });
      google.charts.setOnLoadCallback(setupChart2);
    }

    function setupChart2() {
      var wrap = document.getElementById('chart2-wrap');
      var el = document.getElementById('chart2');
      if (!wrap || !el) return;

      var data = google.visualization.arrayToDataTable([
        ['Gender', 'Severe Symptoms', 'Moderate Symptoms', 'Minimal Symptoms', 'No Response'],
        ['Trans People', 42, 14,  3, 40],
        ['Other',       27, 39,  2, 32],
        ['Cis Women',   10, 24,  9, 57],
        ['Cis Men',      9, 20,  6, 66]
      ]);

      var chart = new google.visualization.ColumnChart(el);

      function computeHeight(w) {
        // Responsive height tuned so: title + plot + legend + subtitle are all visible without scrolling.
        // Clamp keeps it from getting absurdly tall on mobile or too short on desktop.
        var h = Math.round(w * 0.95);
        return Math.max(420, Math.min(620, h));
      }

      function draw() {
        var w = wrap.clientWidth || 740;
        var h = computeHeight(w);
        el.style.height = h + 'px';

        var isNarrow = w < 480;

        var options = {
          width: w,
          height: h,

          title: 'Which genders are most likely to experience severe long COVID?',
          titleTextStyle: { fontSize: 22, bold: true },

          isStacked: true,

          // These two together make the hover target the whole column (category),
          // which stops the rapid hover switching between stacked segments.
          focusTarget: 'category',
          aggregationTarget: 'category',

          legend: {
            position: 'bottom',
            alignment: 'center',
            textStyle: { fontSize: 16 }
          },

          chartArea: {
            left: isNarrow ? 46 : 60,
            right: 18,
            top: 60,
            bottom: 110,
            width: '100%',
            height: '100%'
          },

          vAxis: {
            viewWindow: { min: 0, max: 100 },  // ensures 100 is not clipped away
            ticks: [0, 20, 40, 60, 80, 100],
            textStyle: { fontSize: 16 }
          },

          hAxis: {
            textStyle: { fontSize: 16 } // keeps category labels consistent with your body text scale
          },

          tooltip: {
            isHtml: true,
            textStyle: { fontSize: 14 }
          },

          // Colours: keep whatever you already settled on; adjust only if needed.
          colors: ['#041144', '#0B4B63', '#2E4A1F', '#2F2F2F']
        };

        chart.draw(data, options);

        // Add the subtitle line beneath the legend (inside the same embed, so no scrolling needed)
        injectSubtitle();
      }

      function injectSubtitle() {
        var existing = document.getElementById('chart2-subtitle');
        if (!existing) {
          existing = document.createElement('div');
          existing.id = 'chart2-subtitle';
          existing.style.fontSize = '16px';
          existing.style.lineHeight = '1.35';
          existing.style.marginTop = '10px';
          existing.style.textAlign = 'center';
          existing.textContent = 'Share of people who had COVID and developed Long COVID, by gender, December 2022';
          wrap.appendChild(existing);
        }
      }

      // Redraw on resize â€” debounced, and only when width actually changes (avoids redraw loops).
      var lastW = 0;
      var t = null;
      function onResize() {
        clearTimeout(t);
        t = setTimeout(function () {
          var nowW = wrap.clientWidth || 0;
          if (Math.abs(nowW - lastW) < 2) return;
          lastW = nowW;
          draw();
        }, 120);
      }

      window.addEventListener('resize', onResize, { passive: true });

      // If available, observe the container itself (more reliable inside Wix layouts)
      if (window.ResizeObserver) {
        var ro = new ResizeObserver(onResize);
        ro.observe(wrap);
      }

      // First draw
      lastW = wrap.clientWidth || 0;
      draw();
    }
  })();
</script>
