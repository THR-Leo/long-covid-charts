<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chart 2 – Long COVID symptom severity</title>

  <style>
    /* Prevent internal (iframe) scrollbars */
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: transparent;
      height: 100%;
      width: 100%;
    }

    /* Use a neutral “site-like” system font stack (no Helvetica hard-coding) */
    :root {
      --site-font: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    }

    #wrap {
      box-sizing: border-box;
      width: 100%;
      overflow: hidden;
      font-family: var(--site-font);
    }

    #chart {
      width: 100%;
      overflow: hidden;
    }

    #caption {
      box-sizing: border-box;
      width: 100%;
      padding: 8px 0 0 0;
      font-family: var(--site-font);
      font-size: 16px;
      line-height: 1.3;
      color: #111;
      text-align: center;
    }
  </style>

  <script src="https://www.gstatic.com/charts/loader.js"></script>
</head>

<body>
  <div id="wrap">
    <div id="chart" aria-label="Stacked bar chart of Long COVID symptom severity by gender"></div>
    <div id="caption">Share of people who had COVID and developed Long COVID, by gender, December 2022</div>
  </div>

  <script>
    google.charts.load('current', { packages: ['corechart'] });
    google.charts.setOnLoadCallback(init);

    let chart, data, options;
    let resizeTimer = null;

    function init() {
      data = google.visualization.arrayToDataTable([
        ['Gender', 'Severe Symptoms', 'Moderate Symptoms', 'Minimal Symptoms', 'No Response'],
        ['Trans People', 42, 14, 3, 40],
        ['Other',       27, 39, 2, 32],
        ['Cis Women',   10, 24, 9, 57],
        ['Cis Men',      9, 20, 6, 66]
      ]);

      chart = new google.visualization.ColumnChart(document.getElementById('chart'));

      // IMPORTANT:
      // - Tooltips flicker if the chart is constantly re-drawn (resize loops) or animated.
      // - We debounce resize re-draws and disable animation.
      window.addEventListener('resize', () => {
        window.clearTimeout(resizeTimer);
        resizeTimer = window.setTimeout(draw, 150);
      }, { passive: true });

      draw();
    }

    function draw() {
      const wrap = document.getElementById('wrap');
      const chartDiv = document.getElementById('chart');
      const caption = document.getElementById('caption');

      // Available width inside the iframe
      const w = Math.max(320, wrap.clientWidth || document.documentElement.clientWidth || 320);

      // Mobile vs desktop heuristic
      const isMobile = window.matchMedia && window.matchMedia('(max-width: 600px)').matches;

      // Height budgeting (no scrollbars):
      // We compute a total height that includes the chart (with title + legend) + the caption.
      // Then we force the document to that exact height so the iframe doesn’t need scrollbars.
      const captionH = Math.ceil(caption.getBoundingClientRect().height || 28);

      // Chart height tuned so:
      // - Title is visible
      // - Top tick "100" is visible
      // - Legend is fully visible (not truncated)
      // - No scrolling needed
      //
      // If you want it slightly shorter/taller, adjust these ratios by small amounts.
      const chartH = isMobile
        ? Math.round(w * 1.35)   // mobile needs more vertical room for title/legend
        : Math.round(w * 0.72);  // desktop

      const totalH = chartH + captionH;

      // Hard stop: prevent scrollbars by matching body/wrap heights to content.
      document.documentElement.style.height = totalH + 'px';
      document.body.style.height = totalH + 'px';
      wrap.style.height = totalH + 'px';
      chartDiv.style.height = chartH + 'px';

      options = {
        height: chartH,
        width: w,
        backgroundColor: 'transparent',

        title: 'Which genders are most likely to experience severe long COVID?',
        titleTextStyle: {
          fontName: getComputedStyle(wrap).fontFamily || undefined,
          fontSize: isMobile ? 26 : 18,
          bold: true
        },

        fontName: getComputedStyle(wrap).fontFamily || undefined,

        isStacked: true,
        bar: { groupWidth: isMobile ? '60%' : '65%' },

        // Make sure the "100" tick is visible (avoid clipping at the top)
        vAxis: {
          minValue: 0,
          maxValue: 100,
          viewWindow: { min: 0, max: 100 },
          textStyle: { fontSize: isMobile ? 18 : 12 },
          gridlines: { count: 6 },
          minorGridlines: { count: 0 }
        },

        hAxis: {
          textStyle: { fontSize: isMobile ? 20 : 12 }
        },

        legend: {
          position: 'bottom',
          alignment: 'center',
          maxLines: 2,
          textStyle: { fontSize: isMobile ? 18 : 12 }
        },

        // Chart area tuned so:
        // - Title doesn’t push content into overflow
        // - Top tick label isn't clipped
        // - Legend has enough space
        chartArea: {
          left: isMobile ? 70 : 60,
          right: isMobile ? 20 : 20,
          top: isMobile ? 90 : 55,
          bottom: isMobile ? 95 : 65,
          width: '100%',
          height: '100%'
        },

        tooltip: {
          trigger: 'focus',
          isHtml: false
        },

        // Flicker-control: remove animation so tooltips aren’t fighting transitions
        animation: { duration: 0 },

        // Keep it clean and stable across browsers
        focusTarget: 'category',
        crosshair: { trigger: 'none' }
      };

      chart.draw(data, options);
    }
  </script>
</body>
</html>
